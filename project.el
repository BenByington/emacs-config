(require 'multi-compile)

(defun pb-base-dir ()(locate-dominating-file default-directory ".git"))

(setq proj-debug-state t)
(setq proj-arch "gcc")
(setq proj-remote nil)
(setq proj-subproj nil)

(defun proj-localhost()(interactive) (setq proj-remote nil))
(defun proj-dev00()(interactive) (setq proj-remote "metallica"))
(defun proj-dev01()(interactive) (setq proj-remote "nirvana"))
(defun proj-arch-gcc ()(interactive) (setq proj-arch "gcc"))
(defun proj-arch-icc ()(interactive) (setq proj-arch "icc"))
(defun proj-arch-avx ()(interactive) (setq proj-arch "avx512"))
(defun proj-arch-k1om ()(interactive)(setq proj-arch "k1om"))
(defun proj-debug()(interactive) (setq proj-debug-state t))
(defun proj-release()(interactive) (setq proj-debug-state nil))

(defun proj-generic-build-dirs (proj arch debug)
    (setq baseDir (pb-base-dir))
    (setq relDir (concat proj "/"))
    (cond ((and (string= arch "gcc") debug)       (setq archDir "build/x86_64/Debug_gcc"))
          ((and (string= arch "icc") debug)       (setq archDir "build/x86_64/Debug"))
          ((and (string= arch "icc") (not debug)) (setq archDir "build/x86_64/Release"))
	  (t                                      (setq archDir "invalid-build-arch"))
    )
    (when (file-directory-p (concat baseDir relDir)) 
          (setq return (concat baseDir relDir archDir)))
)
(defun proj-ppa-build-dir (arch debug) (proj-generic-build-dirs "Sequel/ppa" arch debug))
(defun proj-acq-build-dir (arch debug) (proj-generic-build-dirs "Sequel/acquisition" arch debug))
(defun proj-bw-build-dir (arch debug) (proj-generic-build-dirs "Sequel/basewriter" arch debug))
(defun proj-cc-build-dir (arch debug) (proj-generic-build-dirs "Sequel/common" arch debug))
(defun proj-cplusplus-build-dir (arch debug) (proj-generic-build-dirs "common/pacbio-cplusplus-api" arch debug))
(defun proj-bc-build-dir (arch debug)
    (setq baseDir (pb-base-dir))
    (setq relDir "Sequel/basecaller/")
    (cond ((string= arch "gcc")    (setq archDir "build/x86_64_gcc/"))
          ((string= arch "icc")    (setq archDir "build/x86_64/"))
          ((string= arch "avx512") (setq archDir "build/avx512/"))
          ((string= arch "k1om")   (setq archDir "build/k1om/"))
	  (t                       (setq archDir "invalid-arch"))
    )
    (if debug (setq buildDir "Debug") (setq buildDir "Release"))
    (when (file-directory-p (concat baseDir relDir)) 
          (setq return (concat baseDir relDir archDir buildDir)))
)

(defun proj-ppa()        (interactive) (setq proj-subproj "ppa")(fset 'proj-build-dir 'proj-ppa-build-dir))
(defun proj-cpluspus()   (interactive) (setq proj-subproj "cplusplus")(fset 'proj-build-dir 'proj-cplusplus-build-dir))
(defun proj-seq-common() (interactive) (setq proj-subproj "common")(fset 'proj-build-dir 'proj-cc-build-dir))
(defun proj-basecaller() (interactive) (setq proj-subproj "basecaller")(fset 'proj-build-dir 'proj-bc-build-dir))
(defun proj-basewriter() (interactive) (setq proj-subproj "basewriter")(fset 'proj-build-dir 'proj-bw-build-dir))
(defun proj-acquisition()(interactive) (setq proj-subproj "acquisition")(fset 'proj-build-dir 'proj-acq-build-dir))

(defun proj-valid()(interactive)
    (setq valid t)
    (unless (proj-build-dir proj-arch proj-debug-state) (setq valid nil))
    ;; Only gcc allowed locally
    ( when (and (not (string= proj-arch "gcc"))(not proj-remote))
	(setq valid nil)
    )
    ( unless (string= proj-subproj "basecaller")
	(when (or (string= proj-arch "k1om")(string= proj-arch "avx512")) (setq valid nil))
        (when (and (string= proj-arch "gcc")(not(proj-debug))) (setq valid nil))
    )
    valid
)

(setq proj-compile-args nil)
(defun proj-compile-args(arg)(interactive (list (read-string "Compile Args: " proj-compile-args))) 
    (if (string= arg "")
       (setq proj-compile-args nil)
       (setq proj-compile-args arg)
    )
)
(setq proj-run-args nil)
(defun proj-run-args(arg)(interactive (list (read-string "Run Command: " proj-run-args))) 
    (if (string= arg "")
       (setq proj-run-args nil)
       (setq proj-run-args arg)
    )
)

(defun proj-remote-build()
  (concat "ssh " proj-remote " 'cd "
	  (proj-build-dir proj-arch proj-debug-state) "\; "
	  (pb-base-dir) "sync_and_build.sh " proj-compile-args"'")
)
(defun proj-remote-clean()
  (concat "ssh " proj-remote " 'cd "
	  (proj-build-dir proj-arch proj-debug-state) "\; make clean'")
)
(defun proj-remote-cleanbuild()
  (concat "ssh " proj-remote " 'cd "
	  (proj-build-dir proj-arch proj-debug-state)
	  "\; make clean\; " (pb-base-dir)
	  "sync_and_build.sh " proj-compile-args"'")
)
(defun proj-remote-run()
  (if (not proj-run-args)
      (print "No run command specified")
      (concat "ssh " proj-remote " 'cd "
	  (proj-build-dir proj-arch proj-debug-state) "\; "
	  proj-run-args "'")
  )
)

(defun proj-build()
  (concat "make -j12 " proj-compile-args)
)
(defun proj-clean()
  (concat "make clean")
)
(defun proj-cleanbuild()
  (concat "make clean\; make -j12" proj-compile-args)
)
(defun proj-run()
  (if (not proj-run-args)
      (print "No build target specified")
       proj-run-args
  )
)

(setq multi-compile-alist '(
    ((proj-valid) .
	(("RefreshIndex" "cmake -DCMAKE_EXPORT_COMPILE_COMMANDS=1 .; rc -J ." (proj-build-dir "gcc" t)))
    )
    ((and (proj-valid)(not proj-remote)) .
	(("Build" proj-build (proj-build-dir proj-arch proj-debug-state))
	 ("Clean" proj-clean (proj-build-dir proj-arch proj-debug-state))
	 ("CleanBuild" proj-cleanbuild (proj-build-dir proj-arch proj-debug-state))
         ("Run" proj-run (proj-build-dir proj-arch proj-debug-state)))
    )
    ((and (proj-valid) proj-remote) .
	(("Build" . proj-remote-build)
	 ("Clean" . proj-remote-clean)
	 ("CleanBuild" . proj-remote-cleanbuild)
         ("Run" . proj-remote-run))
    )
))

(defun proj-curr-build-dir ()(interactive) (print (proj-build-dir proj-arch proj-debug-state)))
(defun proj-info ()(interactive) (
	print (concat "Host: " (if proj-remote proj-remote "localhost")
		      "\n Project: " proj-subproj
		      "\n Type: " proj-arch
		      " " (if proj-debug-state "Debug" "Release")
		      "\n BuildDir: " (proj-build-dir proj-arch proj-debug-state)
		      (when proj-compile-args (concat "\n Compile Args: " proj-compile-args))
		      (when proj-run-args (concat "\n Run Command: " proj-run-args))
)))

(setq proj-bad-config nil)
(defun proj-compile-private()
       (unless (proj-valid) (setq proj-bad-config "Invalid project configuration.  Check directory and 'proj-info'")(throw 'proj-bad-config t))
       (multi-compile-run)
)

(defun proj-compile()(interactive)
       (save-some-buffers)
       (when (catch 'proj-bad-config (proj-compile-private)) (print proj-bad-config))
)

(global-set-key (kbd "C-S-p") 'proj-compile)

(proj-ppa)
(proj-dev00)
(proj-arch-gcc)
(proj-release)
